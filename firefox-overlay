#!/bin/sh

NAME=$(basename "$0")
HELP=$(command -v firefox-overlay-helper)

USER=$(id -un)
HOME=$(getent passwd "$USER" | cut -d : -f 6)

env_check() {
  if [ ! -d "$HOME/.mozilla/firefox" ] && [ ! -L "$HOME/.mozilla/firefox" ]; then
    printf "%s: directory '%s' not found\n" "$NAME" "$HOME/.mozilla/firefox" 1>&2
    exit 1
  fi

  if [ -z "$XDG_RUNTIME_DIR" ]; then
    printf "%s: XDG_RUNTIME_DIR not set\n" "$NAME" 1>&2
    exit 1
  fi

  if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    printf "%s: directory '%s' not found\n" "$NAME" "$XDG_RUNTIME_DIR"
    exit 1
  fi
}

helper_check() {
  if [ -z "$HELP" ]; then
    printf "%s: firefox-overlay-helper not found\n" "$NAME" 1>&2
    exit 1
  fi

  # support for both sudo and doas; doas takes precedence
  if command -v doas > /dev/null 2>&1; then
    if ! doas -n "$HELP"; then
      printf "%s: cannot run 'doas' without password\n" "$NAME" 1>&2
      exit 1
    fi
  else
    if ! sudo -n "$HELP"; then
      printf "%s: cannot run 'sudo' without password\n" "$NAME" 1>&2
      exit 1
    fi
  fi
}

run_as_root() {
  # support for both sudo and doas; doas takes precedence
  if command -v doas > /dev/null 2>&1; then
    doas -n "$@"
  else
    sudo -n "$@"
  fi
}

overlay_mount() {
  if mountpoint -q "$XDG_RUNTIME_DIR/firefox-overlay/overlay"; then
    printf "%s: overlay already mounted\n" "$NAME" 1>&2
    exit 1
  fi

  if [ -L "$HOME/.mozilla/firefox" ] && [ -d "$HOME/.mozilla/firefox-lower" ]; then
    rm -f "$HOME/.mozilla/firefox"
  elif [ -d "$HOME/.mozilla/firefox" ] && [ ! -e "$HOME/.mozilla/firefox-lower" ]; then
    mv -f "$HOME/.mozilla/firefox" "$HOME/.mozilla/firefox-lower"
  else
    printf "%s: directory '%s' not created\n" "$NAME" "$HOME/.mozilla/firefox-lower" 1>&2
    exit 1
  fi

  ln -s firefox-lower "$HOME/.mozilla/firefox"

  install -d \
    -m "$(stat -c %a "$HOME/.mozilla/firefox-lower")" \
    -o "$(stat -c %u "$HOME/.mozilla/firefox-lower")" \
    -g "$(stat -c %g "$HOME/.mozilla/firefox-lower")" \
    "$XDG_RUNTIME_DIR/firefox-overlay" \
    "$XDG_RUNTIME_DIR/firefox-overlay/overlay" \
    "$XDG_RUNTIME_DIR/firefox-overlay/upper" \
    "$XDG_RUNTIME_DIR/firefox-overlay/work"

  if ! run_as_root "$HELP" -l "$HOME/.mozilla/firefox-lower" -t "$XDG_RUNTIME_DIR/firefox-overlay" mount; then
    printf "%s: failed to mount overlay\n" "$NAME" 1>&2
    exit 1
  fi

  rm -f "$HOME/.mozilla/firefox"

  ln -s "$XDG_RUNTIME_DIR/firefox-overlay/overlay" "$HOME/.mozilla/firefox"
}

overlay_unmount() {
  if mountpoint -q "$XDG_RUNTIME_DIR/firefox-overlay/overlay"; then
    if ! run_as_root "$HELP" -t "$XDG_RUNTIME_DIR/firefox-overlay" unmount; then
      printf "%s: failed to unmount overlay\n" "$NAME" 1>&2
      exit 1
    fi
  fi

  if [ -L "$HOME/.mozilla/firefox" ] && [ -d "$HOME/.mozilla/firefox-lower" ]; then
    rm -f "$HOME/.mozilla/firefox"

    mv -f "$HOME/.mozilla/firefox-lower" "$HOME/.mozilla/firefox"
  fi

  if [ -d "$XDG_RUNTIME_DIR/firefox-overlay" ]; then
    rm -rf "$XDG_RUNTIME_DIR/firefox-overlay/upper"

    rmdir \
      "$XDG_RUNTIME_DIR/firefox-overlay/overlay" \
      "$XDG_RUNTIME_DIR/firefox-overlay/work" \
      "$XDG_RUNTIME_DIR/firefox-overlay"
  fi
}

overlay_flush() {
  if ! mountpoint -q "$XDG_RUNTIME_DIR/firefox-overlay/overlay"; then
    printf "%s: overlay not mounted\n" "$NAME" 1>&2
    exit 1
  fi

  if [ ! -L "$HOME/.mozilla/firefox" ] || [ ! -d "$HOME/.mozilla/firefox-lower" ]; then
    printf "%s: discrepancy detected\n" "$NAME" 1>&2
    exit 1
  fi

  exec rsync -a --delete-after --inplace --no-whole-file \
    "$XDG_RUNTIME_DIR/firefox-overlay/overlay/" "$HOME/.mozilla/firefox-lower/"
}

overlay_check() {
  printf "%b" "${GLD}firefox${RST} (ssd) - "
  du -sh "$HOME/.mozilla/firefox-lower" | awk '{print $1}'

  printf "%b" "${GRN}overlay${RST} (mem) - "
  du -sh "$XDG_RUNTIME_DIR/firefox-overlay/upper" | awk '{print $1}'
}

RST='\033[0;00m'
GRN='\033[0;32m'
GLD='\033[0;33m'

usage() {
  printf "%b\n" "${GLD}USAGE${RST}:"
  printf "%s\n" "    $NAME [SUBCOMMAND]"
  printf "\n"
  printf "%b\n" "${GLD}SUBCOMMANDS${RST}:"
  printf "%b\n" "    ${GRN}m${RST}, ${GRN}mount${RST}      Mount overlay"
  printf "%b\n" "    ${GRN}u${RST}, ${GRN}unmount${RST}    Unmount overlay"
  printf "%b\n" "    ${GRN}f${RST}, ${GRN}flush${RST}      Flush overlay to disk"
  printf "%b\n" "    ${GRN}c${RST}, ${GRN}check${RST}      Check overlay status"
}

set -e

case $1 in
  m | mount)
    env_check
    helper_check
    overlay_mount
    ;;

  u | unmount)
    env_check
    helper_check
    overlay_unmount
    ;;

  f | flush)
    env_check
    overlay_flush
    ;;

  c | check)
    overlay_check
    ;;

  h | -h | help | --help | "")
    usage
    ;;

  *)
    printf "%s: invalid option -- '%s'\n" "$NAME" "$1" 1>&2
    exit 1
    ;;
esac
